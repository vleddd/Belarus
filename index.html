<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DeepYouMap - Календарь и автообновление</title>
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; }
        #map { width:100%; height:100vh; }

        /* Панель даты */
        #date-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        #date-picker {
            padding: 6px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        /* Попап */
        .mapboxgl-popup {
            max-width: 350px !important;
            font-family: 'Arial', sans-serif;
        }
        .mapboxgl-popup-content {
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            background: #2d2d2d;
            color: white;
        }
        .mapboxgl-popup-content h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        .war-info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .war-info-table td {
            padding: 6px 0;
            border-bottom: 1px solid #3a3a3a;
            vertical-align: top;
        }
        .war-info-table tr:last-child td {
            border-bottom: none;
        }
        .war-info-table td:first-child {
            color: #aaa;
            width: 40%;
            padding-right: 10px;
        }
    </style>
</head>
<body>

<!-- Панель выбора даты -->
<div id="date-panel">
    <label for="date-picker">Выбрать дату:</label>
    <input type="date" id="date-picker" />
</div>

<!-- Карта -->
<div id="map"></div>

<script>
    const map = new maplibregl.Map({
        container: 'map',
        style: 'https://api.maptiler.com/maps/01966ded-9a2b-7a36-bad5-71bc7e8b2bf7/style.json?key=A7YSMrQ3OZ0oStEWILkD',
        center: [31.1656, 48.3794],
        zoom: 6
    });

    let currentDate = null;
    let currentSourceId = "war-zones";
    let updateInterval = null;
    const baseUrl = "https://vleddd.github.io/DeepYouMap/maps/";

    function formatArea(area) {
        return (area / 1000000).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' км²';
    }

    async function loadMapData(dateString) {
        try {
            const url = `${baseUrl}map_${dateString}.geojson`;

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("Файл не найден");
            }
            const geojson = await response.json();

            const idToName = {
                "80c27733-0eea-4845-93f5-e8938d4a79b3": "Крым",
                "5cdb851b-4447-41b6-ae6f-a134e8b00236": "ЛДНР"
            };

            geojson.features.forEach(feature => {
                const featureId = feature.id || feature.properties.id || feature.properties.featureId;
                if (idToName[featureId]) {
                    feature.properties.customName = idToName[featureId];
                }
                if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                    feature.properties.calculatedArea = formatArea(turf.area(feature));
                }
            });

            if (map.getSource(currentSourceId)) {
                map.removeLayer('war-polygons-fill');
                map.removeLayer('war-polygons-outline');
                map.removeSource(currentSourceId);
            }

            map.addSource(currentSourceId, {
                type: 'geojson',
                data: geojson
            });

            map.addLayer({
                id: 'war-polygons-fill',
                type: 'fill',
                source: currentSourceId,
                paint: {
                    'fill-color': '#b57edc',
                    'fill-opacity': 0.4
                },
                filter: ['==', '$type', 'Polygon']
            });

            map.addLayer({
                id: 'war-polygons-outline',
                type: 'line',
                source: currentSourceId,
                paint: {
                    'line-color': '#a26bce',
                    'line-width': 2,
                    'line-opacity': 1
                },
                filter: ['==', '$type', 'Polygon']
            });

            map.on('click', 'war-polygons-fill', (e) => {
                const feature = e.features[0];
                const name = feature.properties.customName || feature.properties.name || 'Неизвестный регион';
                const areaFormatted = feature.properties.calculatedArea || 'Неизвестно';

                const popupHTML = `
                    <h3>${name}</h3>
                    <table class="war-info-table">
                        <tr>
                            <td>Площадь:</td>
                            <td>${areaFormatted}</td>
                        </tr>
                    </table>
                `;

                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(popupHTML)
                    .addTo(map);
            });

            map.on('mouseenter', 'war-polygons-fill', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'war-polygons-fill', () => {
                map.getCanvas().style.cursor = '';
            });

        } catch (error) {
            console.error("Ошибка загрузки карты:", error.message);
        }
    }

    document.getElementById('date-picker').addEventListener('change', (e) => {
        const date = new Date(e.target.value);
        if (!isNaN(date)) {
            const dateString = date.toISOString().split('T')[0];
            currentDate = dateString;
            loadMapData(dateString);
        }
    });

    function checkForUpdates() {
        if (currentDate) {
            loadMapData(currentDate);
        }
    }

    // Каждые 10 секунд проверяем обновления
    updateInterval = setInterval(checkForUpdates, 10000);
</script>

</body>
</html>
