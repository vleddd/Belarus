<!DOCTYPE html>
<html>
<head>
    <title>DeepYouMap</title>
    <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet'>
    <style>
        body { margin:0; padding:0; }
        #map { width:100%; height:100vh; }
        
        /* Стиль попапа */
        .mapboxgl-popup {
            max-width: 350px !important;
            font-family: 'Arial', sans-serif;
        }
        .mapboxgl-popup-content {
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            background: #2d2d2d;
            color: white;
        }
        .mapboxgl-popup-content h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        .war-info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .war-info-table td {
            padding: 6px 0;
            border-bottom: 1px solid #3a3a3a;
            vertical-align: top;
        }
        .war-info-table tr:last-child td {
            border-bottom: none;
        }
        .war-info-table td:first-child {
            color: #aaa;
            width: 40%;
            padding-right: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Инициализация карты
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://api.maptiler.com/maps/01966ded-9a2b-7a36-bad5-71bc7e8b2bf7/style.json?key=A7YSMrQ3OZ0oStEWILkD',
            center: [31.1656, 48.3794],
            zoom: 6
        });

        // Функция для форматирования площади
        function formatArea(area) {
            const areaKm2 = area / 1000000;
            return areaKm2.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + ' км²';
        }

        // Загрузка данных
        map.on('load', async () => {
            try {
                // Загрузка GeoJSON данных
                const response = await fetch('https://api.maptiler.com/data/01966d36-bb63-7afa-b59f-a38d3e5107b9/features.json?key=A7YSMrQ3OZ0oStEWILkD');
                const geojson = await response.json();
                
                // Обработка каждого полигона отдельно
                geojson.features.forEach((feature, index) => {
                    if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                        // Создаем отдельный источник для каждого полигона
                        map.addSource(`polygon-${index}`, {
                            type: 'geojson',
                            data: {
                                type: 'FeatureCollection',
                                features: [feature]
                            }
                        });
                        
                        // Добавляем слой для полигона
                        map.addLayer({
                            id: `polygon-layer-${index}`,
                            type: 'fill',
                            source: `polygon-${index}`,
                            paint: {
                                'fill-color': '#d22b2b',
                                'fill-opacity': 0.3,
                                'fill-outline-color': '#a31212'
                            }
                        });
                        
                        // Обработчик клика для этого полигона
                        map.on('click', `polygon-layer-${index}`, (e) => {
                            const clickedFeature = e.features[0];
                            const area = turf.area(clickedFeature);
                            
                            // Создаем HTML для таблички
                            let popupHTML = `
                                <h3>${clickedFeature.properties.name || 'Полигон'}</h3>
                                <table class="war-info-table">
                                    <tr>
                                        <td>Площадь:</td>
                                        <td>${formatArea(area)}</td>
                                    </tr>
                            `;
                            
                            // Добавляем все свойства
                            for (const [key, value] of Object.entries(clickedFeature.properties)) {
                                if (key !== 'name') {
                                    popupHTML += `
                                        <tr>
                                            <td>${key}:</td>
                                            <td>${value || '—'}</td>
                                        </tr>
                                    `;
                                }
                            }
                            
                            popupHTML += `</table>`;
                            
                            // Создаем попап
                            new maplibregl.Popup()
                                .setLngLat(e.lngLat)
                                .setHTML(popupHTML)
                                .addTo(map);
                        });
                        
                        // Изменение курсора
                        map.on('mouseenter', `polygon-layer-${index}`, () => {
                            map.getCanvas().style.cursor = 'pointer';
                        });
                        map.on('mouseleave', `polygon-layer-${index}`, () => {
                            map.getCanvas().style.cursor = '';
                        });
                    }
                });
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                alert('Не удалось загрузить данные. Проверьте консоль для деталей.');
            }
        });
    </script>
</body>
</html>
