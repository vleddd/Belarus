<!DOCTYPE html>
<html>
<head>
    <title>DeepYouMap - Полигоны ЛДНР и Крым</title>
    <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet'>
    <style>
        body { margin:0; padding:0; }
        #map { width:100%; height:100vh; }
        
        .mapboxgl-popup {
            max-width: 350px !important;
            font-family: 'Arial', sans-serif;
        }
        .mapboxgl-popup-content {
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            background: #2d2d2d;
            color: white;
        }
        .mapboxgl-popup-content h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        .war-info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .war-info-table td {
            padding: 6px 0;
            border-bottom: 1px solid #3a3a3a;
            vertical-align: top;
        }
        .war-info-table tr:last-child td {
            border-bottom: none;
        }
        .war-info-table td:first-child {
            color: #aaa;
            width: 40%;
            padding-right: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Инициализация карты
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://api.maptiler.com/maps/01966ded-9a2b-7a36-bad5-71bc7e8b2bf7/style.json?key=A7YSMrQ3OZ0oStEWILkD',
            center: [31.1656, 48.3794],
            zoom: 6
        });

        // Функция для точного форматирования площади
        function formatArea(area) {
            return (area / 1000000).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' км²';
        }

        // Загрузка данных
        map.on('load', async () => {
            try {
                // Загрузка GeoJSON данных
                const response = await fetch('https://api.maptiler.com/data/01966d36-bb63-7afa-b59f-a38d3e5107b9/features.json?key=A7YSMrQ3OZ0oStEWILkD');
                const geojson = await response.json();
                
                // Массив для хранения информации о полигонах
                const polygons = [
                    {
                        name: "ЛДНР",
                        coordinates: [[
                            [38.0, 49.0], [39.5, 49.0], 
                            [39.5, 47.5], [38.0, 47.5], 
                            [38.0, 49.0]
                        ]],
                        color: '#d22b2b'
                    },
                    {
                        name: "Крым",
                        coordinates: [[
                            [32.5, 46.0], [36.5, 46.0],
                            [36.5, 44.5], [32.5, 44.5],
                            [32.5, 46.0]
                        ]],
                        color: '#d22b2b'
                    }
                ];
                
                // Обработка каждого полигона
                polygons.forEach((polygon, index) => {
                    // Создаем GeoJSON для полигона
                    const feature = {
                        type: 'Feature',
                        properties: {
                            name: polygon.name,
                            description: "Особый статус",
                            area: formatArea(turf.area({
                                type: 'Polygon',
                                coordinates: polygon.coordinates
                            }))
                        },
                        geometry: {
                            type: 'Polygon',
                            coordinates: polygon.coordinates
                        }
                    };
                    
                    // Добавляем источник
                    map.addSource(`polygon-${index}`, {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: [feature]
                        }
                    });
                    
                    // Добавляем слой
                    map.addLayer({
                        id: `polygon-layer-${index}`,
                        type: 'fill',
                        source: `polygon-${index}`,
                        paint: {
                            'fill-color': polygon.color,
                            'fill-opacity': 0.3,
                            'fill-outline-color': '#a31212'
                        }
                    });
                    
                    // Обработчик клика
                    map.on('click', `polygon-layer-${index}`, (e) => {
                        const clickedFeature = e.features[0];
                        
                        let popupHTML = `
                            <h3>${clickedFeature.properties.name}</h3>
                            <table class="war-info-table">
                                <tr>
                                    <td>Площадь:</td>
                                    <td>${clickedFeature.properties.area}</td>
                                </tr>
                                <tr>
                                    <td>Статус:</td>
                                    <td>${clickedFeature.properties.description}</td>
                                </tr>
                            </table>
                        `;
                        
                        new maplibregl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(popupHTML)
                            .addTo(map);
                    });
                    
                    // Изменение курсора
                    map.on('mouseenter', `polygon-layer-${index}`, () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', `polygon-layer-${index}`, () => {
                        map.getCanvas().style.cursor = '';
                    });
                });
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка загрузки данных. Проверьте консоль.');
            }
        });
    </script>
</body>
</html>
